# 高性能マンデルブロ集合エクスプローラー：最終報告書

[🇺🇸 English](FINAL_REPORT.md) | [🇯🇵 日本語](FINAL_REPORT_JP.md)

## 1. プロジェクト概要

本プロジェクトは、リアルタイムで極限的なズームレベル（$10^{30}$以上）での描画が可能な、最先端の**マンデルブロ集合エクスプローラー**を実装しました。**摂動論（Perturbation Theory）**と**任意精度演算**（`__float128`を使用）を活用し、**AVX2 SIMD**命令と**OpenMP**並列化によって高速化することで、標準的な浮動小数点演算の精度の限界を克服しています。

## 2. 技術アーキテクチャ

システムはハイブリッドアーキテクチャで構成されています：

- **フロントエンド (Python)**: ウィンドウ管理、ユーザー入力、OpenGLレンダリングを担当します。`ctypes`を使用して高性能なCバックエンドと連携します。
- **バックエンド (C)**: 重い数学的計算を実行します。共有ライブラリ（`.dll`）としてコンパイルされ、特定のCPUアーキテクチャ向けに最適化されています。

### 精度モード

エンジンはズームレベルに基づいて、3つの精度モードを動的に切り替えます：

1. **倍精度 (`double`)**: 高速なハードウェア演算（64ビット）。ズーム $< 10^{13}$ で使用。
2. **拡張倍精度 (`long double`)**: 拡張精度（80ビット）。ズーム $< 10^{17}$ で使用。
3. **摂動論 (ハイブリッド)**: 高精度の参照軌道（128ビット）と低精度の差分（64ビット）を使用。ズーム $> 10^{17}$ で使用。

## 3. 数学的基礎

### 3.1 標準的なマンデルブロ反復

マンデルブロ集合は、関数 $f_c(z) = z^2 + c$ の反復によって定義されます：

$$ Z_{n+1} = Z_n^2 + c $$

ここで、$Z_0 = 0$ であり、$c$ は複素パラメータです。$n \to \infty$ としても $|Z_n|$ が有界のままである場合、点 $c$ は集合に含まれます。

### 3.2 摂動論 (Perturbation Theory)

すべてのピクセルに対して高精度演算を行うのを避けるため、画面の中心に対して単一の**参照軌道**（$X_n$）を高精度（128ビット）で計算します。他の点 $c$ は $c = c_{ref} + \delta_c$ として表されます。
近傍点 $Z_n$ の軌道は $Z_n = X_n + \delta_n$ と表現されます。

これを反復式に代入すると：

$$ X_{n+1} + \delta_{n+1} = (X_n + \delta_n)^2 + (c_{ref} + \delta_c) $$
$$ X_{n+1} + \delta_{n+1} = (X_n^2 + c_{ref}) + (2X_n\delta_n + \delta_n^2 + \delta_c) $$

$X_{n+1} = X_n^2 + c_{ref}$ （参照軌道の定義より）であるため、差分 $\delta_n$ の反復式が得られます：

$$ \delta_{n+1} = 2X_n\delta_n + \delta_n^2 + \delta_c $$

これにより、$|\delta_n|$ が小さいままである限り、標準的な**倍精度**を使用して $\delta_n$ を計算することができ、128ビット演算よりも大幅に高速になります。

### 3.3 2変数線形近似 (Bivariate Linear Approximation - BLA)

初期の反復では、$\delta_n$ は極めて小さく、$\delta_n^2$ の項は無視できます。$\delta_n$ と $\delta_c$ の関係を線形に近似できます：

$$ \delta_n \approx B_n \cdot \delta_c $$

これを線形化された摂動方程式（$\delta_n^2$ を無視）に代入すると：

$$ B_{n+1} \cdot \delta_c = 2X_n (B_n \cdot \delta_c) + \delta_c $$
$$ B_{n+1} = 2X_n B_n + 1 $$

ここで $B_0 = 0$ です。

係数 $B_n$ を事前計算します。オフセット $\delta_c$ を持つ特定のピクセルについて、以下の計算により反復 $k$ まで直接スキップできます：

$$ \delta_k = B_k \cdot \delta_c $$

この最適化（級数近似）により、深いズームレベルでは**反復の50〜80%をスキップ**することが可能になります。

## 4. 実装された最適化

### 4.1 AVX2 SIMD ベクトル化

摂動計算の内部ループは、**AVX2 組み込み関数**（`__m256d`）を使用してベクトル化されています。これにより、CPUは単一の命令サイクルで**4ピクセルを同時に**処理できます。

- **FMA (Fused Multiply-Add)**: $a \cdot b + c$ を1ステップで実行し、速度と精度を向上させます。
- **マスキング**: ベクトル内で発散時間が異なる場合に対応するため、アクティブなピクセルをビットマスクを使用して追跡します。

### 4.2 OpenMP 並列化

ワークロードは、**OpenMP**を使用して利用可能なすべてのCPUコアに分散されます。マンデルブロ集合の一部の領域は他の領域よりも大幅に多くの反復を必要とするため、負荷のバランスをとるために `schedule(guided)` 句が使用されています。

### 4.3 ループ展開と脱出チェックの削減

メインループは4倍に展開されています。高コストな脱出条件チェック（$|Z|^2 > 4$）は**4回の反復ごとに1回**だけ実行され、分岐のオーバーヘッドを削減し、命令パイプラインの効率を向上させています。

### 4.4 適応的反復制限

極限的な深度でも詳細を維持するために、最大反復回数はズームレベルに基づいて動的に調整され、512回から最大**2,097,152回**の範囲で変化します。

## 5. パフォーマンス結果

| ズームレベル | 精度モード | 反復回数 | 時間 (概算) |
| :--- | :--- | :--- | :--- |
| $10^{13}$ | 倍精度 (64-bit) | 16,384 | < 0.1秒 |
| $10^{16}$ | 拡張倍精度 (80-bit) | 65,536 | ~1.2秒 |
| $10^{20}$ | 摂動論 (ハイブリッド) | 131,072 | ~0.8秒 |
| $10^{30}$ | 摂動論 (ハイブリッド) | 1,048,576 | ~0.5秒 |

*注：線形近似（BLA）の効果により、より深いズームでパフォーマンスが向上します。*

## 6. 使用方法

Pythonを使用してエクスプローラーを実行します：

```bash
python smooth_mandelbrot.py
```

- **スクロール**: カーソル位置でのズームイン/アウト
- **左クリック**: ビューの中心を移動
- **ESC**: 終了
